<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocolandia v6.1 - Gestión de Usuarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> tailwind.config = { darkMode: 'class' } </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        body { user-select: none; } input { user-select: text; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen font-sans overflow-hidden transition-colors duration-300 dark:bg-slate-900 dark:text-slate-100">

    <div id="screen-loading" class="fixed inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center text-white">
        <div class="loader mb-4"></div>
        <p class="font-bold tracking-widest animate-pulse">CARGANDO SISTEMA...</p>
    </div>

    <div id="screen-login" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 dark:bg-slate-900 hidden">
        <div class="bg-white dark:bg-slate-800 p-10 rounded-3xl shadow-2xl w-full max-w-md text-center animate-fade-in border border-slate-200 dark:border-slate-700">
            <div class="mb-8">
                <div class="w-24 h-24 bg-orange-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-5xl shadow-xl">
                    <i class="fas fa-users-cog"></i>
                </div>
                <h1 class="text-4xl font-black text-slate-800 dark:text-white tracking-tight">Cocolandia</h1>
                <p class="text-slate-500 dark:text-slate-400 font-medium">Versión 6.1 (Cloud Users)</p>
            </div>
            <form onsubmit="app.login(event)" class="space-y-5 text-left">
                <input id="login-user" type="text" class="w-full p-3 rounded-xl border dark:bg-slate-700 dark:text-white dark:border-slate-600 outline-none focus:border-orange-500 transition-colors" placeholder="Usuario" required>
                <input id="login-pass" type="password" class="w-full p-3 rounded-xl border dark:bg-slate-700 dark:text-white dark:border-slate-600 outline-none focus:border-orange-500 transition-colors" placeholder="Contraseña" required>
                <button class="w-full py-4 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 text-lg">ENTRAR</button>
            </form>
            <p class="mt-4 text-xs text-slate-400">Si es la primera vez: <b>Admin</b> / <b>2508</b></p>
        </div>
    </div>

    <div id="screen-app" class="hidden h-full flex">
        <aside class="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col z-10 shadow-sm transition-colors duration-300">
            <div class="p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-700">
                <div class="flex items-center gap-2">
                    <button onclick="app.modalAjustes()" class="p-2 -ml-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><i class="fas fa-bars text-xl"></i></button>
                    <div class="bg-orange-600 text-white w-8 h-8 flex items-center justify-center rounded-lg"><i class="fas fa-cloud text-xs"></i></div>
                    <h1 class="text-base font-bold tracking-tight dark:text-white">Cocolandia</h1>
                </div>
                <div class="flex flex-col items-end">
                     <div class="flex items-center text-[9px] text-green-600 dark:text-green-400 font-bold uppercase bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded-full">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1 animate-pulse"></span>
                        <span id="user-display-name" class="truncate max-w-[60px]">USER</span>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="app.nav('pos')" id="btn-pos" class="nav-btn w-full flex items-center p-4 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"><i class="fas fa-cash-register w-6 text-center"></i><span class="ml-3 font-medium">Caja</span></button>
                <button onclick="app.nav('clientes')" id="btn-clientes" class="nav-btn w-full flex items-center p-4 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"><i class="fas fa-users w-6 text-center"></i><span class="ml-3 font-medium">Clientes</span></button>
                
                <button onclick="app.nav('inventario')" id="btn-inventario" class="nav-btn w-full flex items-center p-4 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"><i class="fas fa-boxes w-6 text-center"></i><span class="ml-3 font-medium">Inventario</span></button>
                <button onclick="app.nav('ventas')" id="btn-ventas" class="nav-btn w-full flex items-center p-4 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"><i class="fas fa-chart-line w-6 text-center"></i><span class="ml-3 font-medium">Historial</span></button>
                
                <div id="menu-admin-users" class="hidden border-t border-slate-100 dark:border-slate-700 mt-2 pt-2">
                    <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-1">Admin</p>
                    <button onclick="app.nav('users')" id="btn-users" class="nav-btn w-full flex items-center p-4 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all">
                        <i class="fas fa-user-shield w-6 text-center"></i><span class="ml-3 font-medium">Usuarios</span>
                    </button>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 space-y-2">
                <button onclick="app.prepararCierreCaja()" class="w-full flex items-center justify-center p-3 rounded-xl text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 font-bold text-sm transition-all border border-indigo-200 dark:border-indigo-800"><i class="fas fa-file-invoice-dollar mr-2"></i> Cierre de Caja</button>
                <button onclick="location.reload()" class="w-full flex items-center justify-center p-3 rounded-xl text-red-500 hover:bg-red-100 dark:hover:bg-red-900/20 font-bold text-sm transition-all border border-red-200 dark:border-red-900/30"><i class="fas fa-sign-out-alt mr-2"></i> Salir</button>
            </div>
        </aside>

        <main class="flex-1 relative flex flex-col min-w-0 bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
            
            <div id="view-users" class="view-section hidden flex-1 p-8 overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold dark:text-white">Equipo de Trabajo</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Gestiona quién tiene acceso a Cocolandia</p>
                    </div>
                    <button onclick="app.modalUser()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-green-500/30 flex items-center transition-transform active:scale-95">
                        <i class="fas fa-user-plus mr-2"></i> Nuevo Usuario
                    </button>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-slate-700 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-slate-700/50 border-b dark:border-slate-700">
                            <tr>
                                <th class="p-4 dark:text-slate-300">Nombre</th>
                                <th class="p-4 dark:text-slate-300">Usuario</th>
                                <th class="p-4 dark:text-slate-300">Contraseña</th>
                                <th class="p-4 dark:text-slate-300">Rol / Permisos</th>
                                <th class="p-4 dark:text-slate-300 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-users" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-pos" class="view-section hidden flex-1 flex h-full">
                <div class="flex-1 p-6 overflow-y-auto flex flex-col">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm flex items-center border border-slate-200 dark:border-slate-700 mb-4 sticky top-0 z-20">
                        <i class="fas fa-search text-slate-400 ml-2"></i>
                        <input type="text" id="buscador" oninput="app.renderPos(this.value)" placeholder="Buscar producto..." class="flex-1 ml-4 outline-none text-lg bg-transparent dark:text-white" autofocus>
                    </div>
                    <div id="grid-productos" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 pb-20"></div>
                </div>
                <div class="w-96 bg-white dark:bg-slate-800 shadow-2xl border-l border-slate-200 dark:border-slate-700 flex flex-col z-30 transition-colors duration-300">
                    <div class="p-4 bg-indigo-50 dark:bg-slate-700/50 border-b border-indigo-100 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-2"><span class="font-bold text-indigo-900 dark:text-indigo-300 text-sm">CLIENTE</span><span id="puntos-badge" class="hidden bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 text-xs font-bold px-2 py-1 rounded-full">0 pts</span></div>
                        <div class="flex space-x-2" id="client-search-box"><input type="text" id="input-client" placeholder="Tel/ID" class="flex-1 p-2 text-sm border dark:border-slate-600 rounded-lg outline-none dark:bg-slate-700 dark:text-white"><button onclick="app.buscarCliente()" class="bg-indigo-600 text-white px-3 rounded-lg"><i class="fas fa-search"></i></button><button onclick="app.modalCliente()" class="bg-green-500 text-white px-3 rounded-lg"><i class="fas fa-plus"></i></button></div>
                        <div id="client-info-box" class="hidden bg-white dark:bg-slate-700 p-3 rounded-lg border dark:border-slate-600 shadow-sm relative mt-2"><button onclick="app.quitarCliente()" class="absolute top-1 right-1 text-slate-400 hover:text-red-500"><i class="fas fa-times-circle"></i></button><div class="font-bold text-slate-800 dark:text-white" id="lbl-cli-nombre">Nombre</div><div class="text-xs text-slate-500 dark:text-slate-400">ID: <span id="lbl-cli-id">---</span></div></div>
                    </div>
                    <div class="p-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center"><h2 class="font-bold text-sm text-slate-700 dark:text-slate-300">Carrito</h2><span class="text-xs text-slate-400" id="cart-count">0 items</span></div>
                    <div id="cart-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                    <div class="p-5 bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
                        <div class="flex justify-between items-end mb-4"><span class="text-sm font-medium text-slate-500 dark:text-slate-400">Total</span><span id="lbl-total" class="text-4xl font-black text-slate-800 dark:text-white">$0.00</span></div>
                        <div class="space-y-3"><input type="number" id="input-pago" oninput="app.calcCambio()" placeholder="Monto Efectivo" class="w-full p-4 border dark:border-slate-600 rounded-xl outline-none font-bold text-lg dark:bg-slate-700 dark:text-white"><div id="lbl-cambio" class="hidden text-right text-sm font-bold text-green-600 dark:text-green-400">Cambio: $0.00</div><button onclick="app.cobrar('efectivo')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg">COBRAR EFECTIVO</button><button id="btn-pay-points" onclick="app.cobrar('puntos')" disabled class="w-full py-3 bg-slate-300 dark:bg-slate-700 text-slate-500 font-bold rounded-xl text-sm cursor-not-allowed">Selecciona cliente</button></div>
                    </div>
                </div>
            </div>
            <div id="view-ventas" class="view-section hidden flex-1 p-8 overflow-y-auto"><h2 class="text-2xl font-bold mb-6 dark:text-white">Historial (Nube)</h2><div id="list-ventas" class="space-y-2"></div></div>
            <div id="view-clientes" class="view-section hidden flex-1 p-8 overflow-y-auto"><h2 class="text-2xl font-bold mb-6 dark:text-white">Clientes (Nube)</h2><div class="bg-white dark:bg-slate-800 rounded-xl shadow overflow-hidden border dark:border-slate-700"><table class="w-full text-left"><tbody id="table-clientes" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody></table></div></div>
            <div id="view-inventario" class="view-section hidden flex-1 p-8 overflow-y-auto"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold dark:text-white">Inventario (Nube)</h2><button onclick="app.initDemoData()" class="text-xs bg-slate-200 px-2 py-1 rounded">Restaurar Datos Demo</button></div><div class="bg-white dark:bg-slate-800 rounded-xl shadow overflow-hidden border dark:border-slate-700"><table class="w-full text-left"><tbody id="table-inv" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody></table></div></div>
        </main>
    </div>

    <div id="modal-usuario" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border dark:border-slate-700 animate-fade-in">
            <div class="p-6 bg-slate-50 dark:bg-slate-900 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-green-500 p-2 rounded-lg text-white"><i class="fas fa-user-plus"></i></div>
                    <div><h2 class="text-xl font-bold dark:text-white">Nuevo Usuario</h2><p class="text-xs text-slate-500">Define accesos y roles</p></div>
                </div>
                <button onclick="document.getElementById('modal-usuario').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <form onsubmit="app.saveUser(event)" class="p-6 space-y-4">
                <input id="new-user-name" required class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl outline-none" placeholder="Nombre Completo (Ej. Juan Pérez)">
                <div class="grid grid-cols-2 gap-4">
                    <input id="new-user-user" required class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl outline-none" placeholder="Usuario (Ej. juan)">
                    <input id="new-user-pass" required class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl outline-none" placeholder="Contraseña">
                </div>
                
                <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl border border-slate-100 dark:border-slate-600">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-300 uppercase mb-2">Asignar Permisos (Rol)</label>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 bg-white dark:bg-slate-700 rounded-lg border dark:border-slate-600 cursor-pointer hover:border-indigo-500 transition-all">
                            <input type="radio" name="role" value="user" checked class="w-5 h-5 text-indigo-600">
                            <div class="ml-3">
                                <span class="block font-bold text-sm dark:text-white">Cajero (Vendedor)</span>
                                <span class="block text-[10px] text-slate-500 dark:text-slate-400">Puede vender, ver clientes y registrar tickets. NO puede borrar ni ver reportes globales.</span>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-white dark:bg-slate-700 rounded-lg border dark:border-slate-600 cursor-pointer hover:border-indigo-500 transition-all">
                            <input type="radio" name="role" value="admin" class="w-5 h-5 text-indigo-600">
                            <div class="ml-3">
                                <span class="block font-bold text-sm dark:text-white">Administrador (Total)</span>
                                <span class="block text-[10px] text-slate-500 dark:text-slate-400">Control total: Inventario, Usuarios, Historial completo y Ajustes.</span>
                            </div>
                        </label>
                    </div>
                </div>

                <button class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold shadow-lg">CREAR USUARIO</button>
            </form>
        </div>
    </div>

    <div id="modal-ajustes" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border dark:border-slate-700 animate-fade-in">
            <div class="p-6 bg-slate-50 dark:bg-slate-900 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h2 class="font-bold dark:text-white">Configuración</h2><button onclick="document.getElementById('modal-ajustes').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button></div>
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center"><span class="dark:text-white">Modo Oscuro</span><input type="checkbox" id="toggle-theme" onclick="app.toggleTheme()"></div>
                <div class="text-center text-xs text-green-500 font-bold mt-4">● CONECTADO A FIREBASE</div>
            </div>
        </div>
    </div>
    
    <div id="modal-cliente" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 dark:text-white">Nuevo Cliente</h3><form onsubmit="app.saveCliente(event)" class="space-y-4"><input id="new-cli-id" disabled class="w-full bg-slate-100 dark:bg-slate-700 dark:text-white p-2 rounded"><input id="new-cli-nom" required class="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded" placeholder="Nombre"><input id="new-cli-tel" required class="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded" placeholder="Teléfono"><button class="w-full py-2 bg-blue-600 text-white rounded font-bold">Guardar</button><button type="button" onclick="document.getElementById('modal-cliente').classList.add('hidden')" class="w-full py-2 text-slate-500">Cancelar</button></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- ⚠️ AQUÍ PEGA TU CONFIGURACIÓN DE FIREBASE ⚠️ ---
        const firebaseConfig = {
            apiKey: "PEGA_AQUI_TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_NUMERO",
            appId: "TU_APP_ID"
        };
        // ----------------------------------------------------

        let db;
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); console.log("Firebase Conectado"); } catch(e) { console.error("Error Firebase:", e); }

        let STATE = { inv: [], cli: [], ven: [], users: [] };
        let carrito = []; let clienteActivo = null; let currentUser = null;

        window.app = {
            init: async () => {
                if(!db) return;
                onSnapshot(collection(db, "inventario"), (s) => { STATE.inv = []; s.forEach(d => STATE.inv.push({...d.data(), uid: d.id})); app.renderPos(); app.renderInv(); });
                onSnapshot(collection(db, "clientes"), (s) => { STATE.cli = []; s.forEach(d => STATE.cli.push({...d.data(), uid: d.id})); app.renderCliTable(); });
                onSnapshot(collection(db, "ventas"), (s) => { STATE.ven = []; s.forEach(d => STATE.ven.push({...d.data(), uid: d.id})); STATE.ven.sort((a,b)=>b.id-a.id); app.renderHist(); });
                
                // Escuchar Usuarios
                onSnapshot(collection(db, "users"), async (s) => { 
                    STATE.users = []; 
                    s.forEach(d => STATE.users.push({...d.data(), uid: d.id}));
                    
                    // Si no hay usuarios en la BD, crear Admin por defecto
                    if(STATE.users.length === 0) {
                        console.log("Creando Admin Default...");
                        await addDoc(collection(db, "users"), { user: 'Admin', pass: '2508', role: 'admin', name: 'Administrador' });
                    }
                    app.renderUsersTable();
                });

                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('screen-login').classList.remove('hidden');
                
                if(localStorage.getItem('coco_theme')==='dark') { document.documentElement.classList.add('dark'); document.getElementById('toggle-theme').checked=true; }
            },

            login: (e) => {
                e.preventDefault();
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                const found = STATE.users.find(x => x.user.toLowerCase() === u.toLowerCase() && x.pass === p);
                if (found) {
                    currentUser = {...found, inicioTurno: new Date()};
                    document.getElementById('screen-login').classList.add('hidden');
                    document.getElementById('screen-app').classList.remove('hidden');
                    document.getElementById('user-display-name').textContent = found.name.toUpperCase();
                    
                    if(currentUser.role === 'admin') {
                        document.getElementById('menu-admin-users').classList.remove('hidden');
                        document.getElementById('btn-inventario').classList.remove('hidden');
                        document.getElementById('btn-ventas').classList.remove('hidden');
                    } else {
                        // Es Cajero: Ocultar cosas
                        document.getElementById('menu-admin-users').classList.add('hidden');
                        // Cajero no ve inventario completo ni historial total (opcional)
                        document.getElementById('btn-inventario').classList.add('hidden'); 
                    }
                    app.nav('pos');
                } else { alert("Usuario no encontrado o contraseña incorrecta"); }
            },

            // --- GESTIÓN DE USUARIOS ---
            modalUser: () => {
                document.getElementById('new-user-name').value = '';
                document.getElementById('new-user-user').value = '';
                document.getElementById('new-user-pass').value = '';
                document.getElementById('modal-usuario').classList.remove('hidden');
            },
            saveUser: async (e) => {
                e.preventDefault();
                if(currentUser.role !== 'admin') return alert("Solo Admin puede crear usuarios");
                
                const name = document.getElementById('new-user-name').value;
                const user = document.getElementById('new-user-user').value;
                const pass = document.getElementById('new-user-pass').value;
                const role = document.querySelector('input[name="role"]:checked').value;

                await addDoc(collection(db, "users"), { name, user, pass, role });
                alert("Usuario Creado Exitosamente");
                document.getElementById('modal-usuario').classList.add('hidden');
            },
            deleteUser: async (uid) => {
                if(currentUser.role !== 'admin') return;
                if(confirm("¿Seguro que deseas eliminar este usuario?")) {
                    await deleteDoc(doc(db, "users", uid));
                }
            },
            renderUsersTable: () => {
                const t = document.getElementById('table-users'); t.innerHTML = '';
                STATE.users.forEach(u => {
                    const roleBadge = u.role === 'admin' 
                        ? `<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold border border-indigo-200">ADMIN TOTAL</span>` 
                        : `<span class="bg-slate-100 text-slate-600 px-2 py-1 rounded-full text-xs font-bold border border-slate-200">CAJERO</span>`;
                    
                    const deleteBtn = u.user === 'Admin' ? '' : `<button onclick="app.deleteUser('${u.uid}')" class="text-red-400 hover:text-red-600 font-bold text-xs bg-red-50 p-2 rounded hover:bg-red-100">ELIMINAR</button>`;

                    t.innerHTML += `
                    <tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                        <td class="p-4 text-sm font-medium dark:text-white">${u.name}</td>
                        <td class="p-4 text-sm text-slate-500 dark:text-slate-300">${u.user}</td>
                        <td class="p-4 text-sm font-mono text-slate-400">••••</td>
                        <td class="p-4">${roleBadge}</td>
                        <td class="p-4 text-right">${deleteBtn}</td>
                    </tr>`;
                });
            },

            // --- NAVIGATION ---
            nav: (v) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + v).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(btn => btn.className = 'nav-btn w-full flex items-center p-4 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all');
                document.getElementById('btn-' + v).className = 'nav-btn w-full flex items-center p-4 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 font-bold';
            },

            // --- POS LOGIC ---
            renderPos: (f='') => {
                const g = document.getElementById('grid-productos'); g.innerHTML = '';
                STATE.inv.filter(p => p.nombre.toLowerCase().includes(f.toLowerCase())).forEach(p => {
                    g.innerHTML += `<div onclick="app.addCarro('${p.uid}')" class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 hover:border-indigo-500 cursor-pointer shadow-sm ${p.stock<=0?'opacity-50 grayscale':''}"><h3 class="font-bold text-slate-800 dark:text-white text-sm mb-3 h-10 overflow-hidden">${p.nombre}</h3><div class="flex justify-between items-end"><span class="text-xl font-black text-indigo-600 dark:text-indigo-400">$${p.precio}</span><span class="text-[10px] text-slate-400 font-bold">STOCK: ${p.stock}</span></div></div>`;
                });
            },
            addCarro: (uid) => {
                const p = STATE.inv.find(x => x.uid === uid);
                if(!p || p.stock <= 0) return alert("Agotado");
                const item = carrito.find(x => x.uid === uid);
                if(item) { if(item.cant < p.stock) item.cant++; else alert("Sin stock"); } else carrito.push({...p, cant: 1});
                app.renderCart();
            },
            renderCart: () => {
                const list = document.getElementById('cart-list'); list.innerHTML = ''; let total = 0;
                carrito.forEach((p, i) => {
                    total += p.precio * p.cant;
                    list.innerHTML += `<div class="flex justify-between items-center bg-slate-50 dark:bg-slate-700 p-2 rounded border dark:border-slate-600 text-xs"><div><b class="dark:text-white">${p.nombre}</b><br><span class="text-slate-500 dark:text-slate-400">$${p.precio} x ${p.cant}</span></div><div class="flex items-center gap-1"><button onclick="app.modCart(${i},-1)" class="w-6 h-6 bg-white dark:bg-slate-600 rounded">-</button><button onclick="app.modCart(${i},1)" class="w-6 h-6 bg-indigo-100 dark:bg-indigo-900 rounded">+</button></div></div>`;
                });
                document.getElementById('lbl-total').textContent = '$' + total.toFixed(2);
                document.getElementById('cart-count').textContent = carrito.length + ' items';
                app.updateBtnPuntos(); app.calcCambio();
            },
            modCart: (i,d) => {
                const real = STATE.inv.find(p => p.uid === carrito[i].uid);
                if(carrito[i].cant+d > 0 && carrito[i].cant+d <= real.stock) carrito[i].cant+=d; else if(carrito[i].cant+d <= 0) carrito.splice(i, 1);
                app.renderCart();
            },
            calcCambio: () => {
                const total = carrito.reduce((s,i)=>s+(i.precio*i.cant),0); const pago = parseFloat(document.getElementById('input-pago').value);
                const lbl = document.getElementById('lbl-cambio');
                if(pago >= total && total > 0) { lbl.classList.remove('hidden'); lbl.textContent = 'Cambio: $' + (pago-total).toFixed(2); } else lbl.classList.add('hidden');
            },
            cobrar: async (metodo) => {
                const total = carrito.reduce((s,i)=>s+(i.precio*i.cant),0); if(total <= 0) return;
                for (const item of carrito) { const ref = doc(db, "inventario", item.uid); await updateDoc(ref, { stock: item.stock - item.cant }); }
                let pts = 0;
                if(clienteActivo) {
                    const refCli = doc(db, "clientes", clienteActivo.uid);
                    if(metodo === 'puntos') {
                        if(clienteActivo.puntos < total) return alert("Puntos insuficientes");
                        await updateDoc(refCli, { puntos: clienteActivo.puntos - total });
                    } else {
                        pts = Math.floor(total/10);
                        await updateDoc(refCli, { puntos: clienteActivo.puntos + pts });
                    }
                }
                await addDoc(collection(db, "ventas"), { id: Date.now(), fecha: new Date().toLocaleString(), total, metodo, puntos: pts, vendedor: currentUser.user, cliente: clienteActivo ? clienteActivo.id : 'General' });
                alert("Venta Guardada en la Nube ☁️");
                carrito = []; app.quitarCliente(); document.getElementById('input-pago').value = ''; app.renderCart();
            },

            // --- CLIENTES & OTROS ---
            buscarCliente: () => {
                const q = document.getElementById('input-client').value.trim();
                const c = STATE.cli.find(x => x.id === q || x.telefono === q);
                if(c) { clienteActivo = c; app.updateClienteUI(); } else if(confirm("¿Crear?")) app.modalCliente();
            },
            updateClienteUI: () => {
                const badge = document.getElementById('puntos-badge');
                if(clienteActivo) {
                    document.getElementById('client-search-box').classList.add('hidden'); document.getElementById('client-info-box').classList.remove('hidden');
                    document.getElementById('lbl-cli-nombre').textContent = clienteActivo.nombre; document.getElementById('lbl-cli-id').textContent = clienteActivo.id;
                    badge.textContent = clienteActivo.puntos + ' pts'; badge.classList.remove('hidden');
                } else {
                    document.getElementById('client-search-box').classList.remove('hidden'); document.getElementById('client-info-box').classList.add('hidden'); badge.classList.add('hidden');
                }
                app.updateBtnPuntos();
            },
            quitarCliente: () => { clienteActivo = null; app.updateClienteUI(); },
            updateBtnPuntos: () => {
                const btn = document.getElementById('btn-pay-points'); const total = carrito.reduce((s,i)=>s+(i.precio*i.cant),0);
                if(clienteActivo && total > 0 && clienteActivo.puntos >= total) { btn.disabled = false; btn.className = "w-full py-3 bg-green-500 text-white font-bold rounded-xl"; btn.textContent = `Pagar con Puntos`; }
                else { btn.disabled = true; btn.className = "w-full py-3 bg-slate-300 dark:bg-slate-700 text-slate-500 font-bold rounded-xl cursor-not-allowed"; btn.textContent = "Puntos insuficientes"; }
            },
            modalCliente: () => { document.getElementById('new-cli-id').value = 'WT' + Date.now().toString().slice(-5); document.getElementById('modal-cliente').classList.remove('hidden'); },
            saveCliente: async (e) => {
                e.preventDefault();
                await addDoc(collection(db, "clientes"), { id: document.getElementById('new-cli-id').value, nombre: document.getElementById('new-cli-nom').value, telefono: document.getElementById('new-cli-tel').value, puntos: 0 });
                document.getElementById('modal-cliente').classList.add('hidden');
            },
            modalAjustes: () => document.getElementById('modal-ajustes').classList.remove('hidden'),
            toggleTheme: () => { const h = document.documentElement; h.classList.toggle('dark'); localStorage.setItem('coco_theme', h.classList.contains('dark') ? 'dark' : 'light'); },
            prepararCierreCaja: () => {
                if(!currentUser) return;
                const modal = document.createElement('div'); modal.id = 'modal-cierre'; modal.className = 'fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm';
                modal.innerHTML = `<div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 text-center border dark:border-slate-700"><h2 class="text-xl font-bold dark:text-white mb-4">¿Cerrar Turno?</h2><button onclick="location.reload()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold mb-2">SI, CERRAR</button><button onclick="document.getElementById('modal-cierre').remove()" class="w-full py-3 bg-slate-200 text-slate-600 rounded-xl">CANCELAR</button></div>`;
                document.body.appendChild(modal);
            },
            initDemoData: async () => {
                await addDoc(collection(db, "inventario"), { id:'001', nombre:'Coca Cola', precio:18, stock:50 });
                await addDoc(collection(db, "inventario"), { id:'002', nombre:'Agua Ciel', precio:12, stock:40 });
                alert("Datos demo cargados");
            },
            renderCliTable: () => { const t = document.getElementById('table-clientes'); t.innerHTML = ''; STATE.cli.forEach(c => t.innerHTML += `<tr class="border-b dark:border-slate-700"><td class="p-3 text-xs dark:text-white">${c.id}</td><td class="p-3 text-xs dark:text-slate-300">${c.nombre}</td><td class="p-3 text-xs text-orange-600 font-bold">${c.puntos}</td></tr>`); },
            renderInv: () => { const t = document.getElementById('table-inv'); t.innerHTML = ''; STATE.inv.forEach(c => t.innerHTML += `<tr class="border-b dark:border-slate-700"><td class="p-3 text-xs dark:text-white">${c.nombre}</td><td class="p-3 text-xs dark:text-slate-300">$${c.precio}</td><td class="p-3 text-xs font-bold">${c.stock}</td></tr>`); },
            renderHist: () => { const l = document.getElementById('list-ventas'); l.innerHTML = ''; STATE.ven.forEach(v => l.innerHTML += `<div class="bg-white dark:bg-slate-800 p-3 border dark:border-slate-700 rounded text-xs flex justify-between mb-2"><div class="dark:text-white">#${v.id}</div><div class="font-bold dark:text-white">$${v.total}</div></div>`); }
        };

        app.init();
    </script>
</body>
</html>
